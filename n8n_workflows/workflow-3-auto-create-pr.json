{
  "name": "Workflow #3: PRè‡ªå‹•ä½œæˆ",
  "active": true,
  "nodes": [
    {
      "id": "webhook-trigger",
      "name": "Branch Push Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300],
      "parameters": {
        "path": "github-branch-push",
        "httpMethod": "POST",
        "responseMode": "lastNode"
      }
    },
    {
      "id": "check-branch",
      "name": "ãƒ–ãƒ©ãƒ³ãƒåˆ¤å®š",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300],
      "parameters": {
        "jsCode": "const ref = $input.item.json.ref || '';\nconst branch = ref.replace('refs/heads/', '');\n\n// feature/, bugfix/, docs/ ãƒ–ãƒ©ãƒ³ãƒã®ã¿å‡¦ç†\nconst validPrefixes = ['feature/', 'bugfix/', 'docs/'];\nconst isValid = validPrefixes.some(prefix => branch.startsWith(prefix));\n\nif (!isValid) {\n  throw new Error(`å¯¾è±¡å¤–ãƒ–ãƒ©ãƒ³ãƒ: ${branch}`);\n}\n\n// Issueç•ªå·æŠ½å‡º (ä¾‹: feature/issue-123)\nconst issueMatch = branch.match(/issue-(\\d+)/);\nconst issueNumber = issueMatch ? issueMatch[1] : null;\n\n// ãƒ–ãƒ©ãƒ³ãƒã‚¿ã‚¤ãƒ—åˆ¤å®š\nlet branchType = 'feature';\nlet reviewer = 'kenichimiyata';\n\nif (branch.startsWith('bugfix/')) {\n  branchType = 'bugfix';\n  reviewer = 'poe-dari-san';\n} else if (branch.startsWith('docs/')) {\n  branchType = 'docs';\n  reviewer = 'kenichimiyata';\n}\n\nreturn [{\n  json: {\n    branch: branch,\n    branchType: branchType,\n    issueNumber: issueNumber,\n    reviewer: reviewer,\n    repository: $input.item.json.repository.full_name,\n    pusher: $input.item.json.pusher.name,\n    commits: $input.item.json.commits || []\n  }\n}];"
      }
    },
    {
      "id": "get-commits",
      "name": "ã‚³ãƒŸãƒƒãƒˆæƒ…å ±åé›†",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300],
      "parameters": {
        "jsCode": "const commits = $input.item.json.commits || [];\nconst commitMessages = commits.map(c => `- ${c.message}`).join('\\n');\n\nreturn [{\n  json: {\n    ...($input.item.json),\n    commitMessages: commitMessages,\n    commitCount: commits.length\n  }\n}];"
      }
    },
    {
      "id": "create-pr-body",
      "name": "PRæœ¬æ–‡ç”Ÿæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 300],
      "parameters": {
        "jsCode": "const data = $input.item.json;\nconst issueLink = data.issueNumber ? `Closes #${data.issueNumber}` : 'é–¢é€£Issue: ãªã—';\n\nconst prBody = `## å¤‰æ›´å†…å®¹\n\n${data.commitMessages || 'ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—'}\n\n## é–¢é€£Issue\n\n${issueLink}\n\n## ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±\n\n- **ãƒ–ãƒ©ãƒ³ãƒ**: ${data.branch}\n- **ã‚¿ã‚¤ãƒ—**: ${data.branchType}\n- **ã‚³ãƒŸãƒƒãƒˆæ•°**: ${data.commitCount}\n- **ä½œæˆè€…**: @${data.pusher}\n\n## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ\n\n- [ ] ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†\n- [ ] ãƒ†ã‚¹ãƒˆå®Ÿæ–½\n- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°\n- [ ] å‹•ä½œç¢ºèªå®Œäº†\n\n---\nğŸ¤– n8n ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸPR`;\n\nconst prTitle = data.issueNumber \n  ? `[${data.branchType}] Issue #${data.issueNumber} ã®å¯¾å¿œ` \n  : `[${data.branchType}] ${data.branch} ã®å¤‰æ›´`;\n\nreturn [{\n  json: {\n    ...data,\n    prTitle: prTitle,\n    prBody: prBody,\n    base: 'main',\n    head: data.branch\n  }\n}];"
      }
    },
    {
      "id": "create-pr",
      "name": "PRä½œæˆ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1050, 300],
      "parameters": {
        "url": "=https://api.github.com/repos/{{$json.repository}}/pulls",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.GITHUB_TOKEN}}"
            },
            {
              "name": "Accept",
              "value": "application/vnd.github+json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"title\": $json.prTitle, \"body\": $json.prBody, \"head\": $json.head, \"base\": $json.base, \"draft\": false } }}"
      }
    },
    {
      "id": "assign-reviewer",
      "name": "ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã‚¢ã‚µã‚¤ãƒ³",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1250, 300],
      "parameters": {
        "url": "=https://api.github.com/repos/{{$('create-pr-body').item.json.repository}}/pulls/{{$('create-pr').item.json.number}}/requested_reviewers",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.GITHUB_TOKEN}}"
            },
            {
              "name": "Accept",
              "value": "application/vnd.github+json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"reviewers\": [$('create-pr-body').item.json.reviewer] } }}"
      }
    },
    {
      "id": "notify-chat",
      "name": "PRä½œæˆé€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1450, 300],
      "parameters": {
        "url": "={{$env.GOOGLE_CHAT_WEBHOOK}}",
        "method": "POST",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { cardsV2: [{ card: { header: { title: \"ğŸ”€ PRè‡ªå‹•ä½œæˆå®Œäº†\", subtitle: \"PR #\" + $('create-pr').item.json.number, imageUrl: \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\" }, sections: [{ header: \"PRæƒ…å ±\", widgets: [ { textParagraph: { text: \"<b>ã‚¿ã‚¤ãƒˆãƒ«:</b><br>\" + $('create-pr').item.json.title } }, { textParagraph: { text: \"<b>ãƒ–ãƒ©ãƒ³ãƒ:</b> \" + $('create-pr-body').item.json.branch + \" â†’ main\" } }, { textParagraph: { text: \"<b>ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼:</b> @\" + $('create-pr-body').item.json.reviewer } }, { textParagraph: { text: \"<b>ã‚³ãƒŸãƒƒãƒˆæ•°:</b> \" + $('create-pr-body').item.json.commitCount } } ] }, { widgets: [{ buttonList: { buttons: [{ text: \"PR ã‚’é–‹ã\", onClick: { openLink: { url: $('create-pr').item.json.html_url } } }] } }] }] } }] } }}"
      }
    },
    {
      "id": "return-response",
      "name": "ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1650, 300],
      "parameters": {
        "jsCode": "return [{\n  json: {\n    status: 'success',\n    message: 'PRä½œæˆå®Œäº†',\n    pr_url: $('create-pr').item.json.html_url,\n    pr_number: $('create-pr').item.json.number,\n    reviewer: $('create-pr-body').item.json.reviewer\n  }\n}];"
      }
    }
  ],
  "connections": {
    "webhook-trigger": {
      "main": [
        [
          {
            "node": "check-branch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-branch": {
      "main": [
        [
          {
            "node": "get-commits",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get-commits": {
      "main": [
        [
          {
            "node": "create-pr-body",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create-pr-body": {
      "main": [
        [
          {
            "node": "create-pr",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create-pr": {
      "main": [
        [
          {
            "node": "assign-reviewer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "assign-reviewer": {
      "main": [
        [
          {
            "node": "notify-chat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "notify-chat": {
      "main": [
        [
          {
            "node": "return-response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "name": "ai-automation",
      "id": "auto-3"
    }
  ]
}
